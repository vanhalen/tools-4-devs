<?php

namespace App\Services;

class CepService
{
    protected $viaCepService;

    public function __construct(ViaCepService $viaCepService)
    {
        $this->viaCepService = $viaCepService;
    }

    /**
     * Gera um endereço real válido com base nos parâmetros opcionais.
     *
     * @param string|null $uf
     * @param bool $formatted
     * @return array
     * @throws \Exception
     */
    public function gerarEndereco($uf = null, $formatted = true)
    {
        $tentativas = 0;
        $maxTentativas = 10; // Limite para evitar loops infinitos

        do {
            // Gera um CEP aleatório com base na UF, se fornecidos
            $cep = $this->gerarCep($uf);

            // Busca o endereço pelo CEP usando o ViaCepService
            try {
                $endereco = $this->viaCepService->buscarEnderecoPorCep($cep);

                // Verifica se o endereço é válido
                if (!isset($endereco['erro'])) {
                    // Formata o CEP, se necessário
                    if (!$formatted) {
                        $endereco['cep'] = preg_replace('/[^0-9]/', '', $endereco['cep']);
                    }
                    return $endereco;
                }
            } catch (\Exception $e) {
                // Ignora erros do ViaCEP e tenta novamente
            }

            $tentativas++;
        } while ($tentativas < $maxTentativas);

        throw new \Exception("Não foi possível gerar um endereço válido após {$maxTentativas} tentativas.");
    }

    private function gerarCep($uf = null) {
        // Se uma UF foi fornecida, escolhe um CEP dessa UF
        if ($uf && isset($this->cepsValidos[strtoupper($uf)])) {
            $ceps = $this->cepsValidos[strtoupper($uf)];
        } else {
            // Seleciona um estado aleatório se não fornecido
            $ufAleatoria = array_rand($this->cepsValidos);
            $ceps = $this->cepsValidos[$ufAleatoria];
        }

        // Escolhe um CEP aleatório da lista
        return $ceps[array_rand($ceps)];
    }


    private $cepsValidos = [
        'AC' => ['69900-000', '69901-100', '69902-200', '69903-300', '69904-400', '69905-500', '69906-600', '69907-700', '69908-800', '69909-900', '69911-000', '69912-100', '69913-200', '69914-300', '69915-400', '69916-500', '69917-600', '69918-700', '69919-800', '69920-900'],
        'AL' => ['57010-000', '57020-100', '57030-200', '57040-300', '57050-400', '57060-500', '57070-600', '57080-700', '57090-800', '57100-900', '57120-000', '57130-100', '57140-200', '57150-300', '57160-400', '57170-500', '57180-600', '57190-700', '57200-800', '57210-900'],
        'AP' => ['68900-000', '68901-100', '68902-200', '68903-300', '68904-400', '68905-500', '68906-600', '68907-700', '68908-800', '68909-900', '68911-000', '68912-100', '68913-200', '68914-300', '68915-400', '68916-500', '68917-600', '68918-700', '68919-800', '68920-900'],
        'AM' => ['69000-000', '69001-100', '69002-200', '69003-300', '69004-400', '69005-500', '69006-600', '69007-700', '69008-800', '69009-900', '69011-000', '69012-100', '69013-200', '69014-300', '69015-400', '69016-500', '69017-600', '69018-700', '69019-800', '69020-900'],
        'BA' => ['40026-010', '40155-200', '40301-155', '41701-020', '42807-500', '45996-080', '45900-000', '44100-000', '48280-000', '45600-000', '45200-000', '44001-230', '45995-000', '41815-060', '45000-100', '48900-000', '48160-000', '44150-000', '45400-000', '48400-000'],
        'CE' => ['60000-000', '60100-100', '60200-200', '60300-300', '60400-400', '60500-500', '60600-600', '60700-700', '60800-800', '60900-900', '61000-000', '61100-100', '61200-200', '61300-300', '61400-400', '61500-500', '61600-600', '61700-700', '61800-800', '61900-900'],
        'DF' => ['70000-000', '70010-100', '70020-200', '70030-300', '70040-400', '70050-500', '70060-600', '70070-700', '70080-800', '70090-900', '70100-000', '70110-100', '70120-200', '70130-300', '70140-400', '70150-500', '70160-600', '70170-700', '70180-800', '70190-900'],
        'ES' => ['29000-000', '29010-100', '29020-200', '29030-300', '29040-400', '29050-500', '29060-600', '29070-700', '29080-800', '29090-900', '29100-000', '29110-100', '29120-200', '29130-300', '29140-400', '29150-500', '29160-600', '29170-700', '29180-800', '29190-900'],
        'GO' => ['74000-000', '74010-100', '74020-200', '74030-300', '74040-400', '74050-500', '74060-600', '74070-700', '74080-800', '74090-900', '74100-000', '74110-100', '74120-200', '74130-300', '74140-400', '74150-500', '74160-600', '74170-700', '74180-800', '74190-900'],
        'MA' => ['65000-000', '65010-100', '65020-200', '65030-300', '65040-400', '65050-500', '65060-600', '65070-700', '65080-800', '65090-900', '65100-000', '65110-100', '65120-200', '65130-300', '65140-400', '65150-500', '65160-600', '65170-700', '65180-800', '65190-900'],
        'MG' => ['30010-020', '30111-030', '30221-080', '30331-040', '30410-070', '30541-120', '30621-050', '30730-090', '30810-180', '30911-170', '31020-080', '31131-040', '31241-060', '31310-090', '31420-070', '31521-040', '31610-130', '31741-070', '31820-040', '31930-080', '32011-120', '32130-150', '32241-110', '32311-130', '32410-100', '32530-090', '32641-180', '32711-140', '32810-150', '32920-070', '30110-028', '30380-080', '30512-030', '31170-320', '31814-000', '36010-570', '37503-000', '38411-004', '38015-070', '38700-000', '35588-000', '37210-000', '32603-292', '35701-382', '33025-000', '37945-000', '39200-000', '37275-000', '37701-230', '30140-110'],
        'PA' => ['66000-000', '66010-100', '66020-200', '66030-300', '66040-400', '66050-500', '66060-600', '66070-700', '66080-800', '66090-900', '66100-000', '66110-100', '66120-200', '66130-300', '66140-400', '66150-500', '66160-600', '66170-700', '66180-800', '66190-900'],
        'PB' => ['58000-000', '58010-100', '58020-200', '58030-300', '58040-400', '58050-500', '58060-600', '58070-700', '58080-800', '58090-900', '58100-000', '58110-100', '58120-200', '58130-300', '58140-400', '58150-500', '58160-600', '58170-700', '58180-800', '58190-900'],
        'PR' => ['80000-000', '80010-100', '80020-200', '80030-300', '80040-400', '80050-500', '80060-600', '80070-700', '80080-800', '80090-900', '80100-000', '80110-100', '80120-200', '80130-300', '80140-400', '80150-500', '80160-600', '80170-700', '80180-800', '80190-900'],
        'RJ' => ['20010-020', '20090-080', '20131-150', '20240-290', '20261-170', '20321-140', '20350-050', '20410-160', '20521-180', '20630-170', '20741-190', '20830-140', '20921-150', '21010-180', '21130-190', '21241-130', '21331-140', '21430-180', '21521-160', '21641-120', '21711-110', '21890-180', '21930-070', '22011-130', '22130-170', '22250-180', '22320-140', '22430-160', '22541-150', '22610-170', '20031-170', '20271-250', '22450-040', '23052-100', '26042-120', '21061-080', '21044-750', '25976-100', '27520-000', '23845-550', '24141-000', '20750-090', '21510-440', '23946-000', '20050-002', '21810-110', '24900-000', '27280-030', '20040-020', '22640-102'],
        'RS' => ['90020-140', '90130-150', '90241-180', '90311-170', '90420-120', '90530-190', '90611-180', '90741-150', '90830-140', '90921-170', '91010-190', '91130-180', '91221-170', '91310-190', '91441-160', '91530-150', '91610-140', '91741-130', '91820-110', '91931-190', '92010-140', '92121-160', '92230-150', '92341-170', '92410-130', '92530-160', '92641-190', '92721-180', '92810-170', '92920-150', '90010-240', '90230-070', '91770-000', '94030-010', '97573-180', '90250-030', '90520-020', '90850-000', '94100-000', '95300-000', '95900-000', '93410-000', '92020-010', '94420-030', '96020-510', '97050-110', '99150-000', '98801-000', '98200-000', '94480-000'],
        'SC' => ['88000-000', '88010-100', '88020-200', '88030-300', '88040-400', '88050-500', '88060-600', '88070-700', '88080-800', '88090-900', '88100-000', '88110-100', '88120-200', '88130-300', '88140-400', '88150-500', '88160-600', '88170-700', '88180-800', '88190-900'],
        'SP' => ['01234-000', '01320-001', '01418-900', '01504-080', '01523-040', '01630-500', '01790-600', '01870-800', '01914-200', '02025-000', '02145-010', '02234-990', '02318-300', '02470-040', '02580-001', '02640-070', '02730-200', '02820-080', '02911-800', '03018-070', '03142-020', '03241-700', '03378-020', '03451-030', '03529-900', '03650-070', '03789-600', '03891-200', '03942-080', '04083-050', '01001-000', '01311-000', '04094-050', '11030-100', '15025-210', '13025-001', '17012-900', '18045-090', '14020-080', '19060-130', '12242-000', '13560-972', '15014-050', '13218-500', '13465-970', '18070-005', '13400-600', '15014-000', '01049-000', '11013-001'],
        'TO' => ['77000-000', '77010-100', '77020-200', '77030-300', '77040-400', '77050-500', '77060-600', '77070-700', '77080-800', '77090-900', '77100-000', '77110-100', '77120-200', '77130-300', '77140-400', '77150-500', '77160-600', '77170-700', '77180-800', '77190-900'],
    ];

}
